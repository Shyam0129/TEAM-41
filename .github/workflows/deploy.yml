name: Deploy to AWS EC2

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ” Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

    - name: ðŸ”‘ Add EC2 to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

    - name: ðŸš€ Deploy to EC2
      run: |
        ssh ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
          set -e
          
          echo "ðŸ“¦ Pulling latest code..."
          cd ~/TEAM-41
          git pull origin main
          
          echo "ðŸ”§ Updating backend..."
          cd backend
          source venv/bin/activate
          pip install -r requirements.txt --quiet
          
          echo "â™»ï¸ Restarting backend..."
          pm2 restart rexie-backend || pm2 start ecosystem.config.js
          
          echo "ðŸŽ¨ Building frontend..."
          cd ../frontend
          npm install --silent
          npm run build
          
          echo "ðŸŒ Reloading Nginx..."
          sudo systemctl reload nginx
          
          echo "âœ… Deployment completed successfully!"
        ENDSSH

    - name: ðŸ¥ Health Check
      run: |
        echo "â³ Waiting for services to start..."
        sleep 15
        
        echo "ðŸ” Checking backend health..."
        response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.EC2_HOST }}/health)
        
        if [ $response -eq 200 ]; then
          echo "âœ… Health check passed! Backend is healthy."
        else
          echo "âŒ Health check failed! Status code: $response"
          exit 1
        fi

    - name: ðŸ“Š Deployment Summary
      if: success()
      run: |
        echo "ðŸŽ‰ Deployment Summary"
        echo "===================="
        echo "âœ… Code pulled from main branch"
        echo "âœ… Backend dependencies updated"
        echo "âœ… Backend restarted with PM2"
        echo "âœ… Frontend rebuilt"
        echo "âœ… Nginx reloaded"
        echo "âœ… Health check passed"
        echo ""
        echo "ðŸŒ Application URL: http://${{ secrets.EC2_HOST }}"
        echo "ðŸ“š API Docs: http://${{ secrets.EC2_HOST }}/api/docs"

    - name: âŒ Deployment Failed
      if: failure()
      run: |
        echo "âŒ Deployment failed!"
        echo "Please check the logs above for errors."
        echo "Common issues:"
        echo "  - SSH connection failed"
        echo "  - Git pull failed (merge conflicts?)"
        echo "  - Dependencies installation failed"
        echo "  - PM2 restart failed"
        echo "  - Health check failed"
